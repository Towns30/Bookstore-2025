# 总体设计文档

## 项目名称 / 文档作者

- 项目名称：Bookstore书店管理系统

- 文档作者：唐哲宇(Towns)

## 程序功能概述

- 书店管理系统是一个高性能、基于 C++ 实现的命令行（CLI）应用程序。它设计有严格的权限分级和嵌套登录机制，确保操作的安全性和隔离性。

- 核心功能帐户管理： 支持用户的注册、登录（su）、注销（logout）以及由高权限用户进行的帐户创建（useradd）和删除（delete）。

- 图书管理与交易： 提供全面的图书信息查询（show），支持顾客购买（buy）以及员工对图书信息（modify）、库存（import）的管理。

- 日志与财务： 仅限店主（{7} 权限）访问，用于查询财务收支（show finance）、系统操作日志（log），并生成财务和员工工作报告。

- 性能要求： 系统严格遵守数据持久化原则，所有主体数据都实时存储在文件中，禁止驻留内存。为确保高效检索，系统采用基于文件的索引结构（如 B+ 树）来管理 $UserID$ 和 $ISBN$ 等关键数据。首次运行时会自动初始化并创建超级管理员账户 root。

## 主题逻辑说明

### 类、模块、其对外接口，以及调用关系

- `Lexer`模块
- - 功能：接收语句源代码，并解析为`TokenStream`类
- - 对外接口：
```cpp
TokenStream Tokenize(std::string line);
```
- - 关联模块：`Parser`模块(会消费`Lexer`解析出来的`TokenStream`)，`main函数`

- `Parser`模块
- - 功能：接受`Lexer`解析出的`TokenStream`|并转化为对应的`Statement`
- - 对外接口：
```cpp
Statement* parseLine(TokenStream& tokens);
```
- - 关联模块和类：`Lexer`模块(消费`Lexer`模块解析出的`TokenStream`)、`Statement`类(判断并解析为对应`Statement`)

- `Statement`类（抽象类）
- - 功能：存储语句信息和展示语句类型
- - 对外接口：
```cpp
void execute(登陆栈信息);
```
- - 关联模块：主要用派生类起作用，关联所有Manager模块的单例
- - 派生类

| 派生类名称 | 对应指令格式 | 指令权限 | 核心 Manager 调用 |
| --- | --- | --- | --- |
| SuStatement | su [UserID] ([Password])? | {0} | "AccountManager::validate| SessionManager::pushLogin" |
| LogoutStatement | logout| {1} | SessionManager::popLogin |
| RegisterStatement | register [UserID] [Password] [Username]|{0}|| AccountManager::registerUser |
| PasswdStatement | passwd [UserID] ([CurrentPassword])? [NewPassword]|{1}|| AccountManager::changePassword |
| UserAddStatement | useradd [UserID] [Password] [Privilege] [Username] | {3} | AccountManager::userAdd |
| DeleteStatement | delete [UserID] | {7} | AccountManager::deleteUser |
| ShowBookStatement | show (...) | {1} | BookManager::searchBooks |
| BuyStatement | buy [ISBN] [Quantity] | {1} | BookManager::buyBook |
| SelectStatement | select [ISBN] | {3} | "BookManager::createOrSelect (若不存在) | SessionManager::setSelectedBook" |
| ModifyStatement | modify (...) | {3} | BookManager::modifyBook |
| ImportStatement | import [Quantity] [TotalCost] | {3} |BookManager::importBook |
| ShowFinanceStatement | show finance ([Count])? | {7} |FinanceManager::showFinance |
| LogStatement | log | {7} | LogManager::log |
| ReportFinanceStatement | report finance |{7}|FinanceManager::reportFinance |
| ReportEmployeeStatement | report employee |{7}|LogManager::reportEmployee |

- 以下类都作为单例存在（并且它们只执行任务，但要判断图书是否存在之类的，会做权限判断，但在Statement里面也会判一次）

- `LogManager`类（储存和取出日志信息）

- `BookManager`类（完成书籍信息的创建和修改）

- `AccountManager`类（完成账户信息创建和修改）

- `FinanceManager`类（提取和修改盈利信息）

- `BlockList`类(模板类)

实例化为
<UserID, AccountInfo>
<int, BookInfo>
<ISBN, int>
<BookName, int>
<Author, int>
<KeyWord, int>
<Time, LogInfo>
<index, FinanceInfo>

- `LogState`类（记录登录栈信息以及对应用户选择了哪本书）

### 数据存储逻辑

所有数据都是通过BlockList的实例化来存储的本质是键值对

#### 账户信息

- AccountdData
- - UserID Username Password Privilege 
- - 本质上：UserID AccountInfo

#### 图书信息

- BookData
- - index ISBN BookName Author Keyword price enterprice storage
- - 本质上：index BookInfo

- ISBN-index
- - ISBN index

- BookName-index
- - BookName index

- Author-index
- - Author index

- KeyWord-index
- - KeyWord index (这里是一个关键词匹配对应图书的index，不是多对一)

#### 日志信息

- LogData
- - Time Operation UserID true/false
- - 本质上：Time LogInfo

#### 盈利信息

- FinanceData
- - Time Income Outcome
- - 本质上：Time FinanceInfo