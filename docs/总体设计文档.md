# 总体设计文档

## 项目名称 / 文档作者

- 项目名称：Bookstore书店管理系统

- 文档作者：唐哲宇(Towns)

## 程序功能概述

- 书店管理系统是一个高性能、基于 C++ 实现的命令行（CLI）应用程序。它设计有严格的权限分级和嵌套登录机制，确保操作的安全性和隔离性。

- 核心功能帐户管理： 支持用户的注册、登录（su）、注销（logout）以及由高权限用户进行的帐户创建（useradd）和删除（delete）。

- 图书管理与交易： 提供全面的图书信息查询（show），支持顾客购买（buy）以及员工对图书信息（modify）、库存（import）的管理。

- 日志与财务： 仅限店主（{7} 权限）访问，用于查询财务收支（show finance）、系统操作日志（log），并生成财务和员工工作报告。

- 性能要求： 系统严格遵守数据持久化原则，所有主体数据都实时存储在文件中，禁止驻留内存。为确保高效检索，系统采用基于文件的索引结构（如 B+ 树）来管理 $UserID$ 和 $ISBN$ 等关键数据。首次运行时会自动初始化并创建超级管理员账户 root。

## 主题逻辑说明

### 类、模块、其对外接口，以及调用关系

- `Lexer`模块
- - 功能：接收语句源代码，并解析为`TokenStream`类
- - 对外接口：
  ```cpp
  std::vector<Token> Tokenize(std::string line);
  ```
- - 关联模块：`Parser`模块(会消费`Lexer`解析出来的`TokenStream`)，`main函数`

- `Parser`模块
- - 功能：接受`Lexer`解析出的`TokenStream`|并转化为对应的`Statement`指针（使用智能指针）
- - 对外接口：
  ```cpp
  Statement* parseLine(std::vector<Token> &tokens);
  ```
- - 关联模块和类：`Lexer`模块(消费`Lexer`模块解析出的`TokenStream`)、`Statement`类(判断并解析为对应`Statement`)

- `Statement`类（抽象类）
- - 功能：存储语句信息和展示语句类型
- - 对外接口：
  ```cpp
  void Execute();
  ```
- - 关联模块：主要用派生类起作用，关联所有Manager模块的单例
- - 派生类

| 派生类名称 | 对应指令格式 | 指令权限 | 核心 Manager 调用 |
| --- | --- | --- | --- |
| SuStatement | su [UserID] ([Password])? | {0} | AccountManager::Su|
| LogoutStatement | logout| {1} | SessionManager::Logout |
| RegisterStatement | register [UserID] [Password] [Username]|{0}| AccountManager::Register |
| PasswdStatement | passwd [UserID] ([CurrentPassword])? [NewPassword]|{1}| AccountManager::Passwd |
| UserAddStatement | useradd [UserID] [Password] [Privilege] [Username] | {3} | AccountManager::UserAdd |
| DeleteStatement | delete [UserID] | {7} | AccountManager::Delete |
| ShowBookStatement | show (...) | {1} | BookManager::Show |
| BuyStatement | buy [ISBN] [Quantity] | {1} | BookManager::Buy |
| SelectStatement | select [ISBN] | {3} | BookManager::Select |
| ModifyStatement | modify (...) | {3} | BookManager::Modify |
| ImportStatement | import [Quantity] [TotalCost] | {3} |BookManager::Import |
| ShowFinanceStatement | show finance ([Count])? | {7} |FinanceManager::ShowFinanceReport, FinanceManager::ShowAllFinanceReport |
| LogStatement | log | {7} | LogManager::Log |
| ReportFinanceStatement | report finance |{7}|FinanceManager::ReportFinance |
| ReportEmployeeStatement | report employee |{7}|LogManager::ReportEmployee |

- 以下类都作为单例存在（并且它们只执行任务，但要判断图书是否存在之类的，会做权限判断，但在Statement里面也会判一次）

- `LogManager`类（储存和取出日志信息）
- - 对外接口
  ```cpp
  void AddSource(const std::string &source);
  void SetResult();
  void Log();
  void ReportEmployee();
  ```
- `BookManager`类（完成书籍信息的创建和修改）
- - 对外接口
  ```cpp
  void Select(const std::string &isbn);
  void Modify(const BookModifyPackage &book_modify_package);
  void Import(const long long &quantity, const long long total_cost);
  void Show(const BookShowPackage &book_show_package);
  void Buy(const std::string &isbn, const long long &quantity);
  ```
- - 私有功能函数
  ```cpp
  void ShowSortedBooks(std::vector<int> &indexs);
  int CreatNewBook(const std::string &isbn); // 返回新建的index, isbn重复则报错
  void PrintBook(BookInfo book_info);
  void ModifyKeywordIndex(std::array<char, 61> cur_keywords_array, std::array<char, 61> new_keywords_array, int now_index);
  std::vector<std::array<char, 61>> SplitKeywords(std::array<char, 61> keywords);
  ```
- `AccountManager`类（完成账户信息创建和修改，里面会存登录栈，由于其单例性质，所有Manager都可以调用）
- - 对外接口
  ```cpp
  void Su(const std::string &user_id, const std::string &passwd);
  void Logout();
  void Register(const std::string &user_id, const std::string &passwd, const std::string &user_name);
  void Passwd(const std::string &user_id, const std::string &new_passwd, const std::string &cur_passwd = "");
  void UserAdd(const std::string &user_id, const std::string &passwd, int privilege, const std::string &name);
  void Delete(const std::string &user_id);
  int GetCurrentPrivilege();
  int GetCurrentSelectedIndex();
  void SetCurrentSelectedIndex(const int &index);
  std::array<char, 61> GetCurrentUserID();
  std::vector<UserInfo> user_session_; // 用户登陆栈
  ```
- `FinanceManager`类（提取和修改盈利信息）
- - 对外接口
  ```cpp
  void AddFinanceReport(const long long &income, const long long &outcome);
  void ShowFinanceReport(const long long &count);
  void ShowAllFinanceReport();
  void ReportFinance();
  void AddBuyFinance(std::string isbn, const long long &income);
  void AddImportFinance(const long long &outcome);
  ```
- `BlockList`类(模板类)
- - 对外接口
  ```cpp
  void Initialise(std::string file_name);
  void Insert(K key, V value);
  void Delete(K key, V value);
  std::vector<V> Find(K key);
  int CountAllPairs();
  std::vector<V> GetAll();
  std::vector<std::pair<K, V>> GetAllPairs();
  ```
实例化为
<UserID, AccountInfo>
<int, BookInfo>
<ISBN, int>
<BookName, int>
<Author, int>
<KeyWord, int>
<Time, LogInfo>
<index, FinanceInfo>


### 数据存储逻辑

所有数据都是通过BlockList的实例化来存储的本质是键值对

#### 账户信息

- AccountdData
- - UserID Username Password Privilege 
- - 本质上：UserID AccountInfo
  ```cpp
  struct AccountInfo
  {
    std::array<char, 61> user_name_; // 实际长度: 30
    std::array<char, 61> passwd_;    // 实际长度: 30
    int privilege_;                  // 实际取值范围: 0, 1, 3, 7
    auto operator<=>(const AccountInfo &) const = default;
  };
  ```

#### 图书信息

- BookData
- - index ISBN BookName Author Keyword price enterprice storage
- - 本质上：index BookInfo
  ```cpp
  struct BookInfo
  {
    std::array<char, 61> isbn_;     // 实际长度：20
    std::array<char, 61> bookname_; // 实际长度：60
    std::array<char, 61> author_;   // 实际长度：60
    std::array<char, 61> keyword_;  // 实际长度：60
    long long price_;               // 100 * price
    long long storage_;
    auto operator<=>(const BookInfo &) const = default;
  };
  ```

- ISBN-index
- - ISBN index

- BookName-index
- - BookName index

- Author-index
- - Author index

- KeyWord-index
- - KeyWord index (这里是一个关键词匹配对应图书的index，不是多对一)

#### 日志信息

- LogData
- - Time Operation UserID true/false
- - 本质上：Time LogInfo
  ```cpp
  struct LogInfo
  {
    std::array<char, 61> user_id_; // 实际长度：30
    std::array<char, 200> source_;
    int privilege_; // 实际取值范围: 0, 1, 3, 7
    bool result_;
    auto operator<=>(const LogInfo &) const = default;
  };
    ```

#### 盈利信息

- FinanceData
- - Time Income Outcome
- - 本质上：Time FinanceInfo
  ```cpp
  struct FinanceInfo
  {
    long long income_;  // 100 * income
    long long outcome_; // 100 * outcome
    auto operator<=>(const FinanceInfo &) const = default;
  };
  ```

### 其他结构体

#### 用户丐版信息(存于登录栈中)
```cpp
struct UserInfo
{
  std::string user_id_;
  int privilege_;
  int select_book_index_;
  auto operator<=>(const UserInfo &) const = default;
};
```

#### Show/Modify Package(用于打包show/Modify的要求参数)
```cpp
struct BookModifyPackage
{
  std::optional<std::string> isbn_;
  std::optional<std::string> bookname_;
  std::optional<std::string> author_;
  std::optional<std::string> keyword_;
  std::optional<long long> price_; // 存储 price * 100
  auto operator<=>(const BookModifyPackage &) const = default;
};
struct BookShowPackage
{
  enum ShowType
  {
    ALL,
    ISBN,
    BOOKNAME,
    AUTHOR,
    KEYWORD
  } type_ = ALL;
  std::string value_ = "";
  auto operator<=>(const BookShowPackage &) const = default;
};
```